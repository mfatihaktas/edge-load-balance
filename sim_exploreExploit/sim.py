import os, sys
current_dir = os.path.dirname(os.path.realpath(__file__))
parent_dir = os.path.dirname(current_dir)
sys.path.append(parent_dir)

import simpy
import numpy as np

from rvs import *
from client import *
from cluster import *

# N: # clusters
# n: # workers in each cluster
N, n = 3, 1

# m: # clients
m = 1 # 2 * N

req_gen_rate = 0.8 * N * n / m
inter_req_gen_time_rv = Exp(req_gen_rate) # DiscreteRV(p_l=[1], v_l=[1 / req_gen_rate])
serv_rate = 1
serv_time_rv = Exp(serv_rate) # DiscreteRV(p_l=[1], v_l=[1 / serv_rate])

def log_global_vars():
	log(DEBUG, "", N=N, n=n, m=m, inter_req_gen_time_rv=inter_req_gen_time_rv, serv_time_rv=serv_time_rv)

def sim_thompsonSampling(m, num_req_to_finish, num_sim=1):
	log(DEBUG, "started", num_req_to_finish=num_req_to_finish, num_sim=num_sim)

	cum_ET = 0
	for i in range(num_sim):
		log(DEBUG, "*** {}th sim run started".format(i))

		env = simpy.Environment()
		cl_l = [Cluster('cl{}'.format(i), env, num_worker=n) for i in range(N)]
		c_l = [Client('c{}'.format(i), env, num_req_to_finish, inter_req_gen_time_rv, serv_time_rv, cl_l) for i in range(m)]
		net = Net_wConstantDelay('n', env, [*cl_l, *c_l], delay=0)
		env.run(until=c_l[0].act_recv)

		t_l = []
		for c in c_l:
			for req in c.req_finished_l:
				t_l.append(req.epoch_arrived_client - req.epoch_departed_client)
		ET = np.mean(t_l)
		log(INFO, "ET= {}".format(ET))
		cum_ET += ET

	log(INFO, "done")
	return cum_ET / num_sim

def plot_ET():
	num_req_to_finish = 10 # 100
	num_sim = 1 # 10

	m_l, ET_l = [], []
	for m in [1]:
		m_l.append(m)

		ET = sim_thompsonSampling(m, num_req_to_finish, num_sim)
		log(INFO, "ET= {}".format(ET))
		ET_l.append(ET)

	plot.plot(m_l, ET_l, color=next(light_color), marker='x', linestyle='solid', lw=2, mew=3, ms=5)

	fontsize = 14
	plot.legend(fontsize=fontsize)
	plot.ylabel(r'$E[T]$', fontsize=fontsize)
	plot.xlabel(r'$m$', fontsize=fontsize)
	plot.title(r'$N= {}, n= {}$'.format(N, n) + '\n' \
						 r'$X \sim {}$, $S \sim {}$'.format(inter_req_gen_time_rv, serv_time_rv))
	plot.gcf().set_size_inches(6, 4)
	plot.savefig("plot_ET_wrt_m_lambda_{}_mu_{}_N_{}.png".format(req_gen_rate, serv_rate, N), bbox_inches='tight')
	plot.gcf().clear()

	log(DEBUG, "done")

if __name__ == '__main__':
	log_to_std()
	log_to_file('sim.log')

	log_global_vars()

	plot_ET()
